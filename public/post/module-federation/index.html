<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />
    <script type="application/javascript" src='https://blog.achirsh.site/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://blog.achirsh.site/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://blog.achirsh.site/css/github.min.css' />
    <link rel="stylesheet" href='https://blog.achirsh.site/css/github-style.css' />
    <link rel="stylesheet" href='https://blog.achirsh.site/css/light.css' />
    <link rel="stylesheet" href='https://blog.achirsh.site/css/dark.css' />
    <link rel="stylesheet" href='https://blog.achirsh.site/css/syntax.css' />
    <title>Module Federation - achirsh blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/github.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="Module Federation" />
<meta name="keywords"
  content='blog, google analytics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://blog.achirsh.site/post/module-federation/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Module Federation - achirsh blog" />
<meta name="twitter:description"
  content="Module Federation" />
<meta name="twitter:site" content="https://blog.achirsh.site/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://blog.achirsh.site/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Module Federation - achirsh blog">
<meta property="og:description"
  content="Module Federation" />
<meta property="og:url" content="https://blog.achirsh.site/post/module-federation/" />
<meta property="og:site_name" content="Module Federation" />
<meta property="og:image"
  content="https://blog.achirsh.site/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2021-09-07 00:00:00 &#43;0000 UTC" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on" style="justify-content: space-between;">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://blog.achirsh.site/">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>

    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://blog.achirsh.site/">
                  <img class=" avatar-user"
                    src="https://blog.achirsh.site/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://blog.achirsh.site/">achirsh</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://blog.achirsh.site/post/module-federation/">Module Federation</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Tue, 07 Sep 2021 00:00:00 &#43;0000"
                    class="no-wrap">
                    Tue, 07 Sep 2021 00:00:00 &#43;0000</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" class="btn btn-octicon m-0 mr-2 p-2" aria-haspopup="menu" aria-label="Table of Contents" role="button">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                          2710 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><h1 id="module-federation">Module Federation</h1>
<h2 id="动机">动机</h2>
<pre tabindex="0"><code>多个独立的部署可以组成一个应用程序，这些独立的构建之间不应该存在依赖关系，因此可以单独开发和部署它们。

这通常被称为微前端，但并不仅限于此。
</code></pre><h2 id="底层概念">底层概念</h2>
<pre tabindex="0"><code>我们区分本地模块和远程模块。本地模块即为普通模块，是当前构建的一部分。远程模块不属于当前构建，并在运行时从所谓的容器加载。

加载远程模块被认为是异步操作。当使用远程模块时，这些异步操作将被放置在远程模块和入口之间的下一个chunk的加载操作中，如果没有chunk加载操作，就不能使用远程模块。

chunk的加载操作通常是通过调用import()实现的，但也支持像require.ensure或require([...])之类的旧语法。

容器是由容器入口创建的，该入口暴露了对特定模块的异步访问。暴露的访问分为两个步骤：
    1、加载模块（异步的）
    2、执行模块（同步的）

    步骤一将在chunk家在期间完成。步骤二将在与其他（本地和远程）的模块交错执行期间完成。这样一来，执行顺序不受模块从本地转换为远程或从远程转为本地的影响。

容器可以嵌套使用，容易可以使用来自其他容器的模块。容器之间也可以循环依赖。
</code></pre><h2 id="高级概念">高级概念</h2>
<pre tabindex="0"><code>每个构建都充当一个容器，也可将其他构建作为容器。通过这种方式，每个构建都能够通过从对应容器中加载模块来访问其他容器暴露出来的模块。

共享模块是指既可重写的又可作为向嵌套容器提供重写的模块。他们通常指向每个构建中的相同模块，例如相同的库。

packageName选项允许通过设置包名来查找所需的版本。默认情况下，它会自动推断模块请求，当想禁用自动推断时，请讲requiredVersion设置为false
</code></pre><h2 id="构建块building-blocks">构建块（Building blocks）</h2>
<pre tabindex="0"><code>ContainerPlugin(底层API)：
    该插件使用指定的公开模块来创建一个额外的容器入口

ContainerReferencePlugin(底层API)：
    该插件将特定的引用添加到作为外部资源（externals）的容器中，并允许从这些容器中导入远程模块。它还会调用这些容器的override API来为它们提供重载。本地的重载
    （当构建也是一个容器时，通过 __webpack_override__ 或 override API）和指定的重载被提供给所有引用的容器。

ModuleFederationPlugin(高级API)
    ModuleFederationPlugin组合了ContainerPlugin和ContainerReferencePlugin.
</code></pre><h2 id="概念目标">概念目标</h2>
<pre tabindex="0"><code>    1、它既可以暴露，又可以使用webpack支持的任何模块类型
    2、代码块加载应该并行加载所需的所有内容（web：到服务器的单次往返）
    3、从使用者到容器的控制：
        重写模块是一种单向操作
        同级容易不能重写彼此的模块
    4、概念适用于独立于环境
        可用于web、Node.js等
    5、共享中的相对和绝对请求
        会一直提供，及时不使用
        会将相对路径解析到config.context
        默认不会使用requiredVersion
    6、共享中的模块请求
        只在使用时提供
        会匹配构建中所有的相等模块请求
        将提供所有匹配模块
        将从图中这个未知的package.json提取requiredVersion
        当你有嵌套的node_modules时，可以提供和使用多个不同的版本
    7、共享中尾部带有 / 的模块请求将匹配所有具有和这个前缀的模块请求
</code></pre><h2 id="用例">用例</h2>
<pre tabindex="0"><code>每个页面单独构建：
    单页应用的每个页面都是在单独的构建中从容器暴露出来的。主体应用程序(application shell)也是独立构建，会将所有页面作为远程模块来引用。
    通过这种方式，可以单独部署每个页面。在更新路由或添加新路由时部署主体应用程序。主体应用程序将常用库定义为共享模块，以避免在页面构建中出现重复。

将组件库作为容器：
    许多应用程序共享一个通用的组件库，可以将其构建成暴露所有组件的容器。每个应用程序使用来自组件容器的组件。可以单独部署对组件库的更改，而
    不需要重新部署所有应用程序。应用程序自动使用组件库的最新版本。

动态远程容器：
    该容器接口支持get和init方法。init是一个兼容async的方法，调用时，只含有一个参数：共享作用域对象(share scope object)。此对象在远程容器中
    用作共享作用域，并由host提供的模块填充。可以利用它再运行时动态地将远程容器连接到host容器。

    init.js
    (async () =&gt; {
        // 初始化共享作用域(shared scope)用提供的已知此构建和所有远程的模块填充它
        await __webpack_init_sharing__(&#39;default&#39;);
        const container = window.someContainer;   // 或从其他地方获容器
        // 初始化容器 它可能提供共享模块
        await container.init(__webpack_share_scopes__.default);
        const module = await container.get(&#39;/module&#39;)
    })(); 

    容器尝试提供共享模块，但是如果共享模块已经被使用，则会发出警告，并忽略所提供的共享模块。容器仍能将其作为降级模块。

    你可以通过动态加载的方式，提供一个共享模块的不同版本，从而实现A/B测试。

    Tip：
        在尝试动态连接远程容器之前，确保已加载容器。

例子：
    init.js
    funciton loadComponent(scope, module) {
        return async () =&gt; {
            // 初始化共享作用域（shared scope）用提供的已知此构建和所有远程的模块填充它
            await __webpack_init_sharing__(&#39;default&#39;);
            const container = window[scope]; // 或从其他地方获取容器
            // 初始化容器 它可能提供共享模块
            await container.init(__webpack_share_scopes__.default);
            const factory = await window[scope].get(module);
            const Module = factory();
            return Module;
        };
    }

    loadComponent(&#39;abtests&#39;, &#39;test123&#39;)
</code></pre><h2 id="基于promise的动态remote">基于Promise的动态Remote</h2>
<pre tabindex="0"><code>一般来说，remote是使用URL配置的，示例如下：
    module.exports = {
        plugins: [
            new ModuleFederationPlugin({
                name: &#39;host&#39;,
                remotes: {
                    app1: &#39;app1@http://localhost:3001/remoteEntry.js&#39;,
                }
            })
        ]
    }

但是你也可以向remote传递一个promise，其会在运行时被调用。你应该用任何符合上面描述的get/init接口的模块来调用这个promise。例如：
如果你想传递你应该使用哪个版本的联邦模块，你可以通过一个查询参数做以下事情：
    module.exports = {
        plugins: [
            new ModuleFederationPlugin({
            name: &#39;host&#39;,
            remotes: {
                app1: `promise new Promise(resolve =&gt; {
            const urlParams = new URLSearchParams(window.location.search)
            const version = urlParams.get(&#39;app1VersionParam&#39;)
            // This part depends on how you plan on hosting and versioning your federated modules
            const remoteUrlWithVersion = &#39;http://localhost:3001/&#39; + version + &#39;/remoteEntry.js&#39;
            const script = document.createElement(&#39;script&#39;)
            script.src = remoteUrlWithVersion
            script.onload = () =&gt; {
                // the injected script has loaded and is available on window
                // we can now resolve this Promise
                const proxy = {
                get: (request) =&gt; window.app1.get(request),
                init: (arg) =&gt; {
                    try {
                    return window.app1.init(arg)
                    } catch(e) {
                    console.log(&#39;remote container already initialized&#39;)
                    }
                }
                }
                resolve(proxy)
            }
            // inject this script with the src set to the versioned remoteEntry.js
            document.head.appendChild(script);
            })
            `,
            },
            // ...
            }),
        ],
    };

请注意当使用该API时，你必须resolve一个包含get/init API的对象
</code></pre><h2 id="动态public-path">动态Public Path</h2>
<pre tabindex="0"><code>提供一个host api以设置publicPath
$#offerahostapitosetthepublicpath$

可以允许host在运行时通过公开远程模块的方法来设置远程模块的publicPath
当你在host域的子路径上挂载独立不熟的子应用程序时，这种方法特别有用。

场景：
    你在https://my-host.com/app/*上有一个host应用，并且在https://foo-app.com上有一个子应用。
    子应用程序也挂载在host域上，因此，https://foo-app.com 预计可通过https://my-host.com/app/foo=app 和
    https://my-host.com/app/foo/* 请求被重定向到 https://foo-app.com/* 通过代理

示例：
    webpack.config.js(remote)
    module.exports = {
        entry: {
            remote: &#39;./public-path&#39;,
        },
        plugins: [
            new ModuleFederationPlugin({
                name: &#39;remote&#39;,  // 该名称必须与入口名称相匹配
                exposes: [&#39;./public-path&#39;]
            })
        ]
    }

    public-path.js(remote)
    export function set(value) {
        __webpack_public_path__ = value;
    }

    src/index.js(host)
    const publicPath = await import(&#39;remote/public-path&#39;);
    publicPath.set(&#39;/your-public-path&#39;);
</code></pre></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script>
 
 
 
 window.onload = function () {
   const header = document.getElementById('post-header');
   const headerHeight = header.offsetHeight;
   
   document.documentElement.style.scrollPaddingTop = headerHeight + 10 + "px";
 }

 const tocToggleButton = document.getElementById("toc-toggle");

 const tippyInstance = tippy('#toc-toggle', {
  trigger: 'click',
  content: '<div id="table-of-contents">\u003cnav id=\u0022TableOfContents\u0022\u003e\n  \u003cul\u003e\n    \u003cli\u003e\u003ca href=\u0022#动机\u0022\u003e动机\u003c\/a\u003e\u003c\/li\u003e\n    \u003cli\u003e\u003ca href=\u0022#底层概念\u0022\u003e底层概念\u003c\/a\u003e\u003c\/li\u003e\n    \u003cli\u003e\u003ca href=\u0022#高级概念\u0022\u003e高级概念\u003c\/a\u003e\u003c\/li\u003e\n    \u003cli\u003e\u003ca href=\u0022#构建块building-blocks\u0022\u003e构建块（Building blocks）\u003c\/a\u003e\u003c\/li\u003e\n    \u003cli\u003e\u003ca href=\u0022#概念目标\u0022\u003e概念目标\u003c\/a\u003e\u003c\/li\u003e\n    \u003cli\u003e\u003ca href=\u0022#用例\u0022\u003e用例\u003c\/a\u003e\u003c\/li\u003e\n    \u003cli\u003e\u003ca href=\u0022#基于promise的动态remote\u0022\u003e基于Promise的动态Remote\u003c\/a\u003e\u003c\/li\u003e\n    \u003cli\u003e\u003ca href=\u0022#动态public-path\u0022\u003e动态Public Path\u003c\/a\u003e\u003c\/li\u003e\n  \u003c\/ul\u003e\n\u003c\/nav\u003e</div>',
  allowHTML: true,
  placement: 'bottom-start',
  interactive: true,
  arrow: false,
  maxWidth: "none",
  onHide: function () { tocToggleButton.classList.remove("hover"); },
  onShow: function () { tocToggleButton.classList.add("hover"); },
  onShown: function () {
    selectTableOfContentsOption();

    if (window.hasSetupTableOfContentsListeners) {
      return;
    }

    const tableOfContents = document.getElementById("table-of-contents");
    tableOfContents.addEventListener('click', function () {
      
      tippyInstance[0].hide();
    });

    window.hasSetupTableOfContentsListeners = true;
  }
 });

 function selectTableOfContentsOption () {
   const optionSelectedClass = 'table-of-contents-option-selected';

   const tableOfContentsOptions = document.querySelectorAll("#table-of-contents > nav > ul li");

   for (const option of tableOfContentsOptions) {
     

     const [child] = option.children;
     if (child.tagName.toLowerCase() !== 'a') {
       continue;
     }

     if (window.location.href === child.href) {
       child.classList.add(optionSelectedClass);
     } else {
       child.classList.remove(optionSelectedClass);
     }
   }
 }

 window.onhashchange = selectTableOfContentsOption;
</script>


</body>

<script type="application/javascript" src="https://blog.achirsh.site/js/github-style.js"></script>



</html>